# TestFlow V4 小红书图文素材与全链路需求文档

## 项目背景与 V4 目标

V3 已完成预览与导出体验迭代，material 目录仅保留私信话术。作为**测评类自媒体副业全链路工具**，当前仍缺少**小红书图文投放**所需的**标题与正文文案**：需在 material 中完整体现，并经由「AI 从零生成 → 合规与敏感词清洗 → 关联话题」的流水线产出，便于用户直接用于小红书图文发布。

**核心诉求**：

1. material 中**仅包含两个文件**：**文案文件 txt**（标题 + 正文 + 话题）、**话术文件 txt**（私信话术）。
2. 标题与正文由 **AI 从零生成**小红书专用文案（方案 B），在**导出时**才执行生成；**AI 生成失败时使用默认话术内容**兜底。
3. 敏感词与合规规则采用**自有词表 + 规则**，以项目内 **`content-prompt.md`** 为小红书合规文案的 Prompt 与违禁词依据。
4. 话题**纯 AI 生成**，与用户输入的**场景语境完全符合**，内容**无字数限制**，按**小红书爆款文案风格随机生成**。
5. **Prompt 分模块维护**：测评类 AI 的 Prompt 与小红书内容类 AI 的 Prompt 等需**分文件/分模块专门维护**，不得全部写在同一文件内，避免维护困难。
6. **RunMode 由环境变量统一控制**：所有使用到 AI API 的生成（测评生成、小红书文案生成、图片生成等）均由 **RunMode** 控制；RunMode 需**抽离到环境变量**统一配置，便于部署与多环境一致。

---

## 需求一：material 仅两个文件（文案 txt + 话术 txt）

### 目标

ZIP 导出时，**material 目录**只包含两个文件：

| 路径 | 内容 | 说明 |
|------|------|------|
| **material/copy.txt** | 标题 + 正文 + 话题 | 小红书图文用：标题、正文、关联话题，合并在一个文案文件中 |
| **material/scripts.txt** | 私信话术 | 每行一条话术（原 dm_scripts），格式为纯 txt |

不再使用 `dm_scripts.json`、`titles.txt`、`content.txt`、`hashtags.txt` 等分散文件。

### 文案文件 copy.txt 格式约定

**目标**：用户打开 copy.txt 后**整段复制一次即可粘贴到小红书**，无需再按「标题」「正文」「话题」分段复制粘贴。格式需与小红书发帖框的实际展示一致：无任何【标题】【正文】【话题】等占位标签，标题、正文、话题按顺序连续成段。

约定如下：

- **第 1 行**：笔记标题（单行，可含 emoji、标点）。
- **第 2 行起**：正文（可多行，段落间用换行或空行分隔；可含 emoji）。
- **最后一段**：话题，**同一行内用空格分隔**，每个话题带 `#`，例如：`#心理测试 #人格分析 #测评`。不与正文之间空行过多，保持「标题 → 正文 → 话题」一气呵成。

示例（整段可直接复制到小红书使用）：

```
马年抽象谐音梗 🐴哈哈哈,我画你猜第1期
🔴马年预热,我画你猜,灵光一闪,脑洞大开~
#抽象 #谐音梗 #猜谜语 #脑洞 #谐音 #烂梗 #我画你猜 #幽默搞笑 #梗 #忍不住想笑
```

若正文多段，则标题一行、正文若干行、最后一行是空格分隔的话题；**不出现**【标题】、【正文】、【话题】等字样。

### 话术文件 scripts.txt 格式

- 每行一条私信话术，无前缀、无 JSON，纯文本。
- 与现有 `variant.dmScripts` 或 `variant.copyPackage?.dmScripts` 内容一致，仅输出格式改为 txt。

### 迭代内容

1. **ZIP 与 README**
   - `downloadFullZipBundle` 中，material 只写入：
     - `material/copy.txt`：由「标题（第 1 行）+ 正文（若干行）+ 话题（最后一行，空格分隔）」拼接，**无任何【标题】【正文】【话题】标签**，整段可直接复制到小红书。
     - `material/scripts.txt`：由 dmScripts 数组逐行写入。
   - 删除对 `material/dm_scripts.json`、`titles.txt`、`content.txt`、`hashtags.txt` 的写入。
   - README 中「包含文件」只列：`index.html`、`screenshots/*`、`material/copy.txt`、`material/scripts.txt`、`README.txt`，并说明用途。

2. **数据结构**
   - 用于写入 material 的数据仍可沿用 `copyPackage` 或等价结构（如 `titles`、`content`、`hashtags`、`dmScripts`），仅在**写入 ZIP 时**合并为上述两个文件；内存/API 结构可按实现需要保留数组或字符串。

### 验收

- 导出的完整 ZIP 解压后，material 内**仅有** `copy.txt`、`scripts.txt`。
- `copy.txt` 为标题→正文→话题的连续文本，无【标题】【正文】【话题】等标签，**整段复制即可粘贴到小红书**；`scripts.txt` 每行一条话术。README 中说明两个文件用途。

---

## 需求二：AI 从零生成小红书文案 + 导出时生成 + 失败兜底

### 目标

- **初稿与成稿**：采用**方案 B**，由 AI **从零生成**「小红书图文专用」的标题 + 正文（非从现有 headline/description 拼装）。生成风格需符合小红书用户与爆款文案，与用户输入的**场景语境完全符合**，**无字数限制**，可**随机生成**不同风格的爆款向文案。
- **执行时机**：在**导出时**才执行该生成（即用户点击导出 ZIP 或导出「小红书文案」时触发）；不在「生成测评」时预生成。
- **失败兜底**：若 AI 生成失败（超时、报错、解析失败等），则使用**默认话术内容**作为标题、正文、话题写入 material，保证导出包始终可用。

### 迭代内容

1. **生成流程**
   - 导出时（或导出前一步）调用「小红书文案生成」流水线，输入：当前变体（主题、风格、题目与结果概要、用户输入的场景/语境）、可选随机种子或风格参数。
   - 输出：标题（一条或多条）、正文、话题列表；再经敏感词清洗（需求三）后写入 `copy.txt`；话术来自现有 `dmScripts` 写入 `scripts.txt`。
   - 若该流水线任一步失败，则回退为**默认话术内容**（见下）。

2. **默认话术内容（兜底）**
   - 需在代码或配置中维护一份默认文案，例如：标题可用变体 `headline` 或固定模板「<主题> 测评｜<风格名>」；正文可用变体 `description` 或简短引导语；话题可用变体原有 `hashtags` 或通用如 `#心理测试`、`#测评` 等。确保 copy.txt 与 scripts.txt 在失败时仍有可用的默认内容。

3. **与导出的衔接**
   - 方案一：在 `downloadFullZipBundle` 被调用时，若检测到该变体尚未有「小红书文案」缓存（或强制刷新），则先同步调用生成 API，成功则用生成结果写入 material，失败则用默认话术写入。
   - 方案二：Preview 页在「导出 ZIP」前增加一步「生成小红书文案」的请求，成功后将结果暂存（内存或存储），再执行 ZIP 打包；若该步失败则用默认话术打包。具体由实现选择，以「导出时才生成」且「失败有兜底」为准。

4. **Prompt 与风格**
   - 文案生成所用 Prompt 需单独维护（见需求六），要求：与用户输入场景语境完全一致、无字数限制、可随机生成小红书爆款风格；合规与违禁词部分引用 `content-prompt.md` 规则。

### 验收

- 导出 ZIP 时才会触发小红书文案生成；不导出不调用。
- 生成的标题、正文、话题与测评主题/风格/场景语境一致，风格偏小红书爆款，无字数硬性限制。
- AI 失败时，material 中 copy.txt、scripts.txt 仍为默认话术内容，ZIP 可正常导出且可读。

---

## 需求三：敏感词清洗（自有词表 + content-prompt.md）

### 目标

对 AI 生成的**标题与正文**按小红书平台规则进行**敏感词/违禁词清洗**，避免违规与限流。规则与词表以项目内 **`content-prompt.md`** 为权威来源（内含完整违禁词表与替代表达技巧），实现采用**自有词表 + 替换规则**（方案 A）。

### 迭代内容

1. **规则来源**
   - **`content-prompt.md`** 作为小红书合规文案的 Prompt 与违禁词依据，其中：
     - 「完整违禁词词表」用于敏感词检测与替换（可解析为词表文件或内嵌于代码/配置）。
     - 「替代表达技巧」等用于生成阶段或后处理时的替换策略（如“最有效”→“我用着感觉还不错”）。
   - 生成阶段：可在调用 LLM 时将该文档作为 system prompt 或规则说明，使生成结果尽量合规；后处理阶段：对生成结果再做一遍违禁词扫描与替换，双保险。

2. **清洗范围与顺序**
   - 仅对写入 **copy.txt** 的标题、正文做清洗；scripts.txt（私信话术）是否清洗可由产品后续决定，V4 不做强制要求。
   - 流水线顺序：AI 生成标题+正文+话题 → **敏感词清洗**（标题、正文）→ 写入 copy.txt。

3. **实现方式**
   - 自有词表：可从 `content-prompt.md` 中提取或维护一份同源词表（可配置路径或独立词表文件），对标题与正文做检测与替换/脱敏（如替换为 *** 或使用「替代表达技巧」中的替换句）。
   - 不依赖第三方敏感词 API；若后续需要可扩展。

### 验收

- 写入 copy.txt 的标题与正文已过基于 `content-prompt.md` 的违禁词清洗，无未处理的明确违禁词。
- 词表或规则可配置/可扩展（如独立词表文件或环境变量指向），便于后续运营维护。

---

## 需求四：话题纯 AI 生成（场景语境一致 + 爆款随机）

### 目标

- 话题**纯 AI 生成**，与用户输入的**场景语境完全符合**；内容**无字数限制**，根据**小红书爆款文案**风格**随机生成**。
- 话题写入 **copy.txt** 的最后一行（与标题、正文连续，空格分隔），不单独成文件。

### 迭代内容

1. **生成要求**
   - 由 LLM 根据变体信息（主题、风格、题目与结果概要、用户输入的场景/语境）生成一组关联话题（如 #心理测试 #人格分析 等），格式为带 # 的短标签，数量建议 5–10 个，可与标题+正文同一次调用中输出，或单独一步调用。
   - 需与测评内容强相关，且符合小红书平台习惯；可加入随机性或多组模板，使每次生成有一定随机感（爆款向）。

2. **与流水线顺序**
   - 话题与标题、正文在同一生成流程中产出为宜，再经敏感词清洗（仅标题、正文，话题一般不含长文案，若产品要求也可对话题做违禁词过滤），最后一并写入 copy.txt。

### 验收

- copy.txt 中最后一行话题存在且与测评主题/风格/场景语境一致；风格偏小红书爆款，具备一定随机性。
- 无明确违规或禁用话题。

---

## 需求五：执行时机与失败兜底汇总

### 已确认

- **执行时机**：在**导出的时候才生成**小红书文案（标题+正文+话题）；不在「生成测评」时预生成。
- **失败兜底**：若 AI 生成失败，使用**默认话术内容**填充 copy.txt（及 scripts.txt 仍用现有 dmScripts），保证导出包始终可用的两个文件。

### material 目录结构（定稿）

| 路径 | 内容 |
|------|------|
| **material/copy.txt** | 标题（第1行）+ 正文 + 话题（最后一行空格分隔），整段可复制到小红书 |
| **material/scripts.txt** | 私信话术，每行一条 |

README 中仅列出上述两项并说明用途。

---

## 需求六：Prompt 分模块维护（技术约束）

### 目标

**测评类 AI 的 Prompt** 与 **小红书内容类 AI 的 Prompt**（及后续可能有的其他场景）需**分文件/分模块专门维护**，不得全部写在同一个文件内，避免维护困难、职责混杂。

### 迭代内容

1. **目录与职责建议**
   - 现有测评生成相关 Prompt（主题解构、变体生成、风格约束等）保留在现有模块（如 `lib/prompts.ts` 或已有文件）；若当前全部集中在一个文件，建议拆分为按用途区分的模块或文件，例如：
     - `lib/prompts/` 或等价结构下：`assessment.ts`（测评生成）、`xiaohongshu.ts` 或 `content.ts`（小红书文案生成）、`sensitive.ts`（敏感词/合规规则引用）等；或
     - 保持单文件但按「测评」「小红书」「敏感词」等区块清晰分隔，并注明「新增 Prompt 不得堆叠到同一块」。
   - **小红书文案与合规**：以 **`content-prompt.md`** 作为该场景的权威 Prompt 与违禁词来源；代码中通过读取该文件或引用其路径加载规则，避免在代码中重复粘贴大段违禁词。若需在代码中内嵌精简版规则，需注明「完整版见 content-prompt.md」。

2. **约定**
   - 新增与「测评生成」无关的 Prompt（如小红书文案、敏感词替换提示等）应放在独立模块或独立文件中；同一文件内若包含多类 Prompt，需用注释或命名空间明确区分，便于后续维护与扩展。

### 验收

- 代码库中存在明确的「测评类 Prompt」与「小红书/内容类 Prompt」的分离（不同文件或不同模块/区块）。
- `content-prompt.md` 被引用或加载用于小红书合规与违禁词，而非在代码中重复维护一份完整词表。

---

## 需求七：RunMode 与环境变量统一控制（技术约束）

### 目标

**所有使用到 AI API 的生成**（测评生成、小红书文案生成、图片生成等）均由 **RunMode** 控制（如 `api` 走远程 API，`local` 走本地模板/兜底）。RunMode 需**抽离到环境变量**统一配置，避免散落在多处逻辑中，便于部署与多环境一致。

### 迭代内容

1. **环境变量约定**
   - 新增环境变量用于 RunMode（或等效「是否使用远程 AI」）的默认或强制取值，例如：
     - **`RUN_MODE`**（服务端）：`api` | `local`。服务端生成逻辑（如 `/api/generate`、导出时小红书文案生成）读取该变量；若为 `local`，则强制使用本地模板/默认话术，不调用外部 LLM/图片 API。
     - **`NEXT_PUBLIC_RUN_MODE`**（前端可选）：`api` | `local`。用于前端 RunMode 的**默认值**（如页面加载时 runMode 的初始状态）；可与现有 UI 切换并存，但默认由环境变量决定，便于不同部署环境（开发/预发/生产）统一行为。
   - 若仅保留一个变量，建议服务端用 `RUN_MODE`、前端默认与 `RUN_MODE` 或 `NEXT_PUBLIC_RUN_MODE` 对齐（前端可读的需 `NEXT_PUBLIC_` 前缀）。

2. **受控范围**
   - 以下路径需受 RunMode（或环境变量）控制，行为一致：
     - 测评生成：当前已通过请求体 `provider` / `forceLocal` 与前端 runMode 配合；需增加服务端对 `RUN_MODE` 的读取，当 `RUN_MODE=local` 时强制走本地，忽略请求体中的 provider。
     - 小红书文案生成（V4）：导出时若 `RUN_MODE=local`，则不调用 AI 生成标题/正文/话题，直接使用默认话术写入 material。
     - 图片生成（若存在）：同样在 `RUN_MODE=local` 下不调用 Nano Banana 等外部 API，或使用占位图/跳过。
   - 所有「是否调用远程 AI」的判断应**统一**来自同一套配置（环境变量 + 可选请求体覆盖），而不是各写各的判断。

3. **实现约定**
   - 在代码中抽离一个**统一的 RunMode 读取点**（如 `lib/runmode.ts` 或从 `process.env.RUN_MODE` / `process.env.NEXT_PUBLIC_RUN_MODE` 读取），供测评 API、导出逻辑、未来小红书文案 API 等共用。
   - `.env.example` 中增加 `RUN_MODE` 一个并应用到读取点即可。

### 验收

- 存在环境变量 `RUN_MODE`，且已在 `.env.example` 中声明。
- 测评生成、小红书文案生成（V4）、图片生成等所有 AI 调用路径均通过统一 RunMode 判断；当 `RUN_MODE=local` 时，不调用外部 AI API，使用本地/默认内容。
- 前端 RunMode 的默认值由环境变量决定（或与后端一致），便于部署时一次配置、全链路生效。

---

## 实施顺序建议

| 顺序 | 需求 | 说明 |
|------|------|------|
| 1 | 需求七（RunMode + 环境变量） | 抽离 RunMode 到环境变量，统一所有 AI 生成路径的开关，便于先落地再扩展 V4。 |
| 2 | 需求六（Prompt 分模块） | 先确立目录与引用方式，便于后续接入小红书 Prompt 与 content-prompt.md。 |
| 3 | 需求三（敏感词 + content-prompt.md） | 解析/加载 content-prompt.md 词表与规则，实现标题与正文的清洗逻辑。 |
| 4 | 需求二 + 需求四（生成 + 话题） | 实现「导出时」触发的 AI 从零生成（标题+正文+话题），与默认话术兜底。 |
| 5 | 需求一 + 需求五（material 两文件） | 统一 material 为 copy.txt + scripts.txt，ZIP 与 README 只写入这两个文件。 |

---

## 关于「测评类自媒体副业全链路」的说明

当前理解的全链路为：

- **选题/主题输入** → **主题解构与理论建构**（V2）→ **多变体生成**（V2）→ **预览与多分辨率**（V3）→ **导出 ZIP**（H5、截图、material）→ **V4：导出时生成小红书文案（标题+正文+话题）与话术，material 仅 copy.txt + scripts.txt，合规依据 content-prompt.md**。

V4 不包含「发布到小红书」「数据回流」等平台侧能力；目标为**在导出包中提供可直接用于小红书图文发布的完整文案与话术，且导出时才生成、失败有兜底、Prompt 分模块维护**。

---

文档已按确认定稿，可直接进入开发。
