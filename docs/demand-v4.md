# TestFlow V4 多风格 H5 模板与导出「看全」需求文档

## 项目背景与 V4 目标

在测评标题、内容、问题与答案一致的前提下，当前仅有一套固定的 H5 视觉样式用于手机预览与导出，无法满足小红书投放时对**多风格、高辨识度**的需求；同时，Preview 页为 HTML 可滚动可看全内容，而导出截图若仅按 1080×1440 单屏比例裁切，会导致**内容被裁、无法看全**。V4 聚焦：

1. **多套 H5 风格样式**：同一测评下提供多套可选的视觉风格，用户在 Preview 上可直观切换并查看效果。
2. **风格模板可扩展、易维护**：样式以模板/主题体系组织，新增风格不改业务逻辑，便于运营与设计迭代。
3. **导出图片「看全」**：导出的图片应保证内容完整可见，而非单纯按固定比例单屏截图；参考 V3 对 3:4 的约定，在「看全」前提下兼顾小红书竖图习惯。

**核心诉求**：

- 在 **Preview 页**：用户可选择「风格模板」，手机预览 iframe 内即时展示该风格下的 H5，所见即所得。
- **导出 HTML**：按用户所选风格输出独立 HTML，风格与预览一致。
- **导出截图**：在保证「内容看全」的前提下产出适合小红书使用的图片（长图或分屏多张等方案见下）。
- **架构**：风格与内容解耦，新增风格仅需扩展配置/模板，不侵入核心渲染与导出逻辑。

---

## 需求一：多套 H5 风格样式（可选 + 可扩展）

### 目标

- 同一测评（标题、描述、题目、选项、结果）下，提供**多套视觉风格**供用户选择，包括但不限于：配色、字体、圆角、背景、卡片样式、按钮样式、标签样式等。
- 用户在 **Preview 页**能**切换风格**，**手机预览区域**内嵌的 H5 即时切换为对应风格，直观看到效果。
- 风格体系**可扩展、易维护**：新增风格通过增加「风格模板」配置或新模板文件即可，不修改业务数据结构与导出主流程。

### 现状

- `buildStandaloneHtml` 内嵌单套 CSS（暖色、amber 强调、固定圆角与字体），无风格参数。
- Preview 页仅能切换变体与分辨率，无法切换「同一变体下的不同风格」。
- 截图 `lib/screenshot.ts` 使用硬编码的 `createBaseSlide` 样式，与 HTML 风格一致但无多风格支持。

### 迭代内容

1. **风格模板抽象**
   - 定义**风格模板**数据结构（如 `ThemeTemplate` 或 `StylePreset`）：包含 `id`、`name`、`description`（可选）、以及样式相关字段（如 CSS 变量集合或主题 token：`--bg`、`--surface`、`--text`、`--accent`、`--border`、`--radius`、字体、背景渐变等）。
   - 内置**多套预设风格**，例如（名称与视觉可依产品定稿）：
     - **暖杏**（当前默认）：暖色背景、amber 强调、圆角卡片，适合通用测评。
     - **薄荷绿**：浅绿/薄荷色系，清爽、偏健康/心理类。
     - **克莱因蓝**：高饱和度蓝与白，偏冷静、专业感。
     - **奶油黄**：柔和黄与米白，偏治愈、生活类。
     - **极简白**：白底、灰字、细线框，偏克制、高端。
     - **暗色**：深色背景、浅字、高对比，偏夜间/个性。
   - 每套风格在 Preview 与导出时**共用同一套 token**，保证 HTML 与截图（若按风格渲染）视觉一致。

2. **Preview 页风格切换**
   - 在 **手机预览区域**（中栏）增加**风格选择**控件（如下拉或 Tab），与「分辨率」控件并列或分组，位置仍在手机预览右上方区域。
   - 选项列表来自「风格模板」配置；切换后，传入 `buildStandaloneHtml` 的 `themeId`（或等价参数）变更，重新生成 HTML 并更新 iframe 的 `srcDoc`，实现**即时预览**。
   - 左栏变体列表、右栏导出面板不变；导出时以**当前选中的风格**为准。

3. **buildStandaloneHtml 与风格**
   - `buildStandaloneHtml(variant, options?)` 增加可选参数 `themeId`（或 `theme` 对象）。根据 `themeId` 从风格模板中取对应 CSS 变量/片段，注入到生成的 HTML `<style>` 中，替换或覆盖默认样式。
   - 实现方式二选一或组合：
     - **方式 A**：在 `lib/export.ts` 或独立 `lib/themes.ts` 中维护「主题 id → CSS 变量块」的映射，`buildStandaloneHtml` 拼接到 `<style>`。
     - **方式 B**：每套风格对应一个小的「样式片段」文件或字符串（如 `themes/warm.ts`、`themes/mint.ts`），按需拼接，便于设计师单独维护。

4. **可扩展性约定**
   - 新增风格：仅需在「风格模板」列表中加入新项，并提供对应的 CSS 变量或样式片段，无需改 `TestVariant`、题目渲染逻辑或导出 ZIP 的主流程。
   - 风格列表可配置（如从配置文件或常量数组读取），便于后续运营增加「节日款」「联名款」等。

### 验收

- Preview 页手机预览区域有风格选择控件，至少 3 套以上风格可切换；切换后 iframe 内 H5 样式即时变更，标题/内容/问题/答案不变，仅视觉风格变化。
- 导出 HTML 时，生成的独立 HTML 与当前所选风格一致。
- 新增一套风格仅需新增配置/样式片段，不修改核心数据结构与导出主流程；代码结构清晰，便于后续加风格。

---

## 需求二：导出截图「看全」内容（非单屏比例裁切）

### 目标

- **Preview 页**为 HTML，可滚动，用户能看全封面、题目、选项、结果等全部内容。
- **导出截图**不应只是「固定 1080×1440 单屏」按比例裁切一屏，否则长内容会被裁掉、无法看全。导出图片应保证**内容完整可见**，同时兼顾小红书竖图习惯（参考 V3 的 3:4 竖图语境）。

### 现状

- `lib/screenshot.ts` 中 `generateSlideScreenshots` 按「封面 / 每题一页 / 每个结果一页」生成多张 1080×1440 的图，每张是单屏固定画布，内容多时单页内可能拥挤或字号被迫缩小，且**没有「整页长图」或「按内容高度自适应」**的选项。
- 用户诉求：希望导出的图也能「看全」——即要么单张图内能看全当前屏应展示的完整内容，要么提供「长图」或「分屏但每屏内容完整」的策略。

### 迭代内容

1. **「看全」策略定义**
   - **单页内容看全**：对「封面」「每题」「每个结果」的每一屏，保证该屏内应展示的文案、选项等**完整落在画布内**，不因固定 1080×1440 而被裁切。实现方式可包括：
     - 按内容高度**自适应画布高度**（如封面：固定宽度 1080，高度由内容计算，最小 1440，若内容多则增高），再导出为一张图；或
     - 保持 1080×1440，但**缩小字号与间距**或**分块排版**，使该屏逻辑内容全部在一张图内可读（需保证可读性，避免过小）。
   - **长图导出（可选）**：提供「整页长图」导出选项——将封面 + 所有题目 + 所有结果按顺序拼成**一张长图**（宽 1080，高为各区块高度之和），用户可一次性拿到「能看全」的一张图，便于小红书长图或裁剪分段发布。
   - 若实现复杂度考虑，V4 可先做「单页内容看全」+「多张 3:4 图（每张内容完整）」，长图作为后续迭代。

2. **与风格模板统一**
   - 截图渲染（`createBaseSlide` 或等价逻辑）应支持**风格参数**，使用与 HTML 一致的 theme token（颜色、圆角、字体等），这样「导出截图」与「导出 HTML」在视觉上一致，且多风格下截图也随风格变化。

3. **技术实现要点**
   - **自适应高度**：对封面/题目/结果页，先根据 variant 数据与当前风格渲染到 offscreen 容器，用 `html2canvas` 时设置 `height` 为内容实际高度（或按内容计算出的安全高度），或采用「多段渲染再拼接」得到长图。
   - **文件命名与 ZIP**：若为多张图，保持 `screenshots/cover.png`、`screenshots/q1.png` 等；若增加长图，可命名为 `screenshots/full-page.png` 或放入单独选项。README 中说明截图尺寸与「看全」策略。

4. **参考 V3**
   - V3 要求截图 1080×1440、3:4 竖图、一屏内可读。V4 在「看全」前提下可保留 3:4 单张输出，但单张内必须保证该屏**内容完整**（不裁字、不裁选项）；若一屏放不下则增高画布或拆为多张，不做「裁切掉下半部分」的单一 3:4 截图。

### 验收

- 导出截图时，每一张图（封面/每题/结果）内，该屏应展示的标题、描述、选项、结果文案等**完整可见**，无关键内容被裁切。
- 若实现长图选项：导出的长图包含封面 + 全部题目 + 全部结果，宽度 1080，高度随内容，可一次性看全。
- 截图视觉风格与当前所选 H5 风格一致（颜色、字体、圆角等）。
- 文档/README 中说明导出截图的「看全」策略及尺寸约定。

---

## 需求三：导出面板与风格、看全策略的衔接

### 目标

- 导出面板（ExportPanel）的「导出 HTML」「导出截图」「导出完整 ZIP」与**当前选中的风格**、**截图看全策略**一致。
- 用户心智：在 Preview 选好风格后，点导出即得到该风格下的 HTML 与截图；截图内容看全，不出现「预览能看全、导出图被裁」的落差。

### 迭代内容

1. **Preview 页状态**
   - 当前选中的 **风格 id** 与 **变体** 一起作为 Preview 页状态；调用 `buildStandaloneHtml(variant, { themeId })` 与 `generateSlideScreenshots(variant, { themeId, fullContent?: boolean })` 时传入该状态。

2. **ExportPanel**
   - 不改变三个按钮的职责（导出 HTML、导出截图、导出 ZIP）；导出时由父组件（Preview 页）传入**当前风格 id**（及可选「是否长图」等），在 `handleExportHtml`、`handleExportScreenshots`、`handleExportZip` 中使用该风格与看全策略。
   - 若产品需要，可在导出面板增加简短说明：「当前风格：xxx」「截图将包含完整内容」等，避免用户误解。

3. **ZIP 包**
   - ZIP 内 HTML 为当前风格的独立 HTML；screenshots 为当前风格 + 看全策略下的截图；material 等按现有逻辑不变。

### 验收

- 在 Preview 切换风格后，导出 HTML / 截图 / ZIP 均为该风格；截图内容看全，与需求二一致。
- 导出面板与 Preview 风格选择、分辨率选择无冲突，状态一致。

---

## 需求四：风格模板的技术架构（可扩展、易维护）

### 目标

- 风格以**模板/主题**形式存在，与业务逻辑解耦；新增或修改风格不需改 `TestVariant`、题目渲染、导出 ZIP 的主流程。
- 便于多端复用：同一套 theme 既用于 `buildStandaloneHtml`，也用于 `generateSlideScreenshots`（若截图采用 DOM 渲染）。

### 迭代内容

1. **主题数据结构建议**
   - `lib/themes.ts`（或等价模块）：
     - 导出 `THEME_PRESETS: Array<{ id: string; name: string; description?: string; tokens: ThemeTokens }>`。
     - `ThemeTokens` 包含 CSS 变量名与值（如 `--bg`、`--surface`、`--text`、`--accent`、`--border`、`--radius`、`--fontHeading`、`--fontBody` 等），以及可选 `screenshotOverrides`（截图专用背景色等）。
   - `getThemeById(id: string)` 返回对应 theme 或默认 theme，供 export 与 screenshot 调用。

2. **HTML 注入方式**
   - `buildStandaloneHtml` 内 base 样式保留结构（选择器、布局），仅将「颜色、圆角、字体」等改为从 `theme.tokens` 生成 `:root { ... }` 或对应变量块，注入到 `<style>` 中。

3. **截图与主题**
   - `generateSlideScreenshots(variant, options?: { themeId?: string; fullContent?: boolean })`：
     - 若传入 `themeId`，从 `getThemeById(themeId)` 取 token，在 `createBaseSlide` 或 DOM 渲染时应用相同颜色、圆角等。
     - 若实现长图或自适应高度，在 `options` 中通过 `fullContent: true` 或 `mode: 'fullPage'` 等触发对应渲染分支。

4. **可维护性**
   - 新增风格：在 `THEME_PRESETS` 中 push 新对象，或在独立文件（如 `themes/mint.ts`）中导出 theme，再在 presets 中引用；不修改 `export.ts`、`screenshot.ts` 的核心流程，仅传参。
   - 样式迭代：修改某 theme 的 `tokens` 或样式片段即可，无需改多处硬编码。

### 验收

- 代码中存在明确的 `themes` 模块（或等价），主题列表与 token 定义集中、可读。
- 新增一套风格只需新增配置/样式并注册到列表，无需改 `buildStandaloneHtml` 的布局逻辑与 `generateSlideScreenshots` 的截图流程（仅传 themeId）。
- 文档或注释说明「如何新增风格」，便于后续维护。

---

## 实施顺序建议

| 顺序 | 需求 | 说明 |
|------|------|------|
| 1 | 需求四（风格模板架构） | 先落地 `lib/themes.ts` 与 token 结构，以及 `buildStandaloneHtml(variant, { themeId })` 的注入方式，为多风格打基础。 |
| 2 | 需求一（多套风格 + Preview 切换） | 实现 3～6 套预设风格，Preview 页增加风格选择与 iframe 即时切换。 |
| 3 | 需求二（导出看全） | 实现单页内容完整、可选长图或自适应高度；截图渲染接入 themeId，与 HTML 风格一致。 |
| 4 | 需求三（导出面板衔接） | 导出逻辑传入当前风格与看全策略，保证导出物与预览一致。 |

---

## 与 V3、现有能力的衔接

- **V3**：保留 1080×1440 作为小红书竖图基准尺寸；V4 在「看全」前提下可单张 3:4 或长图，不在未告知用户的情况下裁切内容。
- **现有 export/screenshot**：在现有 `buildStandaloneHtml`、`generateSlideScreenshots` 上扩展参数与主题注入，不破坏现有 ZIP、material、README 等结构；与 demand-v5 的 material 两文件、文案生成等无冲突。
- **Preview 布局**：继续三栏布局，风格与分辨率控件均位于手机预览区域右上方，不新增整页级栏位。

---

文档已按上述确认定稿，可直接进入开发实现。
