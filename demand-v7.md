# TestFlow V7 变体输入模式与变体类型单选需求文档

## 项目背景与 V7 目标

当前首页通过「生成数量」滑动条 + 按钮选定数量后，由后端**随机抽样**变体类型（A/B/C/D/E 五种测评风格），即**抽卡式随机变体生成**。V7 在**保持该滑动抽卡能力不变**的前提下，新增**自主选择变体类型**的能力，并增加一个**模式变量**控制：要么使用滑动输入抽卡，要么使用选择变体类型（**仅支持单选**）。**默认采用选择模式**。

**核心诉求**：

1. **模式变量**：新增变量控制「抽卡模式」与「选择模式」，**默认为选择模式**。
2. **选择模式**：在首页「生成数量」区块（含滑动条）**下方**新增**变体类型单选**，用户只能选择**一个**要生成的变体类型（A/B/C/D/E），生成数量固定为 1。
3. **抽卡模式**：**保持不变**——沿用现有「生成数量」滑动条 + 数字按钮，后端随机抽样，逻辑与 V6 一致；该模式下不展示变体类型选择。
4. **API 与后端**：请求体支持两种形态（抽卡 vs 选择），后端在选择模式下按**单个**指定变体类型生成 1 个变体，不再随机抽样。

---

## 需求一：模式变量定义

### 目标

- 用**一个变量**控制首页变体生成方式：**抽卡（滑动输入）** 或 **选择（变体类型单选）**。
- **默认值为「选择」**，即首次进入或未显式切换时，使用选择变体类型的方式。

### 迭代内容

1. **变量命名与取值**
   - 建议命名：**`variantInputMode`**（或等价名称，如 `variantSelectionMode`）。
   - 取值：**`"draw"`**（抽卡）| **`"select"`**（选择）。
   - 默认：**`"select"`**。

2. **存放位置**
   - **前端**：首页组件内 `useState`，初始值为 `"select"`；可置于 URL 查询参数或本地存储以便记忆用户偏好（可选）。
   - 若需**环境变量**控制默认模式（如 `NEXT_PUBLIC_DEFAULT_VARIANT_INPUT_MODE=select|draw`），可在读取初始 state 时使用，便于部署统一默认行为。

3. **与现有控件的配合**
   - 当 `variantInputMode === "draw"` 时：**保持原样**——展示「生成数量」滑动条 + 数字按钮，不展示变体类型选择；提交时传 `count`，后端随机抽样。
   - 当 `variantInputMode === "select"` 时：展示变体类型**单选**（见需求二），固定生成 1 个变体；不展示「生成数量」滑动条；提交时传单个所选变体 label（如 `selectedVariantLabel: "A"`）。

### 验收

- 首页存在模式切换（如 Tab 或 Toggle）：抽卡 / 选择，默认选中「选择」。
- 切换模式后，下方表单项与提交参数与上述约定一致。

---

## 需求二：变体类型单选（选择模式）

### 目标

- 在首页「生成数量」区块**下方**新增**变体类型单选**区域（仅在 `variantInputMode === "select"` 时展示）。
- 用户**只能选择一种**要生成的变体类型（A/B/C/D/E），生成数量固定为 **1**。
- 变体类型与现有 `ASSESSMENT_STYLES` 一致：A/B/C/D/E，对应「第一眼图像投射型」「场景选择剧情型」「情感依恋指数型」「人生潜力预测型」「心理健康自评型」。

### 迭代内容

1. **展示与数据源**
   - 选项列表来自 `lib/prompts.ts` 的 **ASSESSMENT_STYLES**（或前端可用的同源常量）：A～E，展示名称用 `style.name`（如「第一眼图像投射型」），value 用 label（如 `"A"`）。
   - 可同时展示短标签（A/B/C/D/E）与中文名，便于识别。
   - 控件形式：**单选**（单选按钮组或下拉框），必选一项。

2. **与「图像变体」开关的联动**
   - **A（第一眼图像投射型）** 依赖 `requiresImage: true`，即需开启「图像变体」时才可用。
   - 当「图像变体」关闭时：A 项**置灰不可选**，并在 UI 上说明（如「需开启图像变体」）；若当前已选 A 再关闭图像变体，则自动清空选择或切到其他项并提示用户。
   - 选择模式下，若选中 A，则必须 `enableImageVariants === true`，否则提交前校验不通过或后端返回 400。

3. **数量**
   - 选择模式下固定生成 **1 个变体**，无需展示数量滑动条；可展示说明「将生成 1 个变体」。

4. **提交参数**
   - 选择模式下，请求体增加字段：**`selectedVariantLabel: string`**（单个值，如 `"A"`）；不传 `count` 或传 `count: 1`，由后端按该 label 生成 1 个变体。

### 验收

- 选择模式下，在「生成数量」下方可见 A～E 五种变体类型**单选**，必须选且仅能选 1 个；关闭图像变体时 A 不可选且逻辑正确。
- 提交后，后端按 `selectedVariantLabel` 生成 1 个对应变体。

---

## 需求三：API 与后端逻辑

### 目标

- `/api/generate` 的请求体同时支持**抽卡**与**选择**两种形态。
- **抽卡**：**保持不变**——沿用现有 `count` + 随机抽样 `sampleAssessmentStylesByPolicy`，逻辑与 V6 一致。
- **选择**：接收 `selectedVariantLabel`（单个 label），按指定类型生成 **1 个**变体，不再随机抽样；图像变体约束需校验。

### 迭代内容

1. **请求体 Schema 扩展**
   - 保留现有：`topic`、`count`、`enableImageVariants`、`strictRemote`、`qualityGateEnabled`、`provider`。
   - 新增可选字段：
     - **`variantInputMode`**（可选）：`"draw"` | `"select"`，与前端一致，用于明确语义。
     - **`selectedVariantLabel`**（可选）：`string`，仅在选择模式下使用，取值为 `"A"`|`"B"`|`"C"`|`"D"`|`"E"` 之一。
   - 约定：
     - 当存在 **`selectedVariantLabel`** 且为合法单字母时，视为**选择模式**：固定生成 **1 个**变体，不再使用 `count`；后端按该 label 取 `ASSESSMENT_STYLES[label]` 生成。
     - 当不存在 `selectedVariantLabel` 或为空时，视为**抽卡模式**：使用 `count`，继续调用 `sampleAssessmentStylesByPolicy` 随机抽样（**与现有一致**）。

2. **后端校验**
   - 选择模式：
     - `selectedVariantLabel` 必须在 `["A","B","C","D","E"]` 内。
     - 若 `enableImageVariants === false` 且 `selectedVariantLabel === "A"`，返回 400 并提示「未开启图像变体时不能选择第一眼图像投射型（A）」。
   - 抽卡模式：**保持现有** `count` 与 `maxCount` 校验不变。

3. **后端生成逻辑**
   - 选择模式：不调用 `sampleAssessmentStylesByPolicy`；用 `ASSESSMENT_STYLES[selectedVariantLabel]` 得到 `{ label: selectedVariantLabel, style }`，按现有 `createVariantWithProvider` 流程生成 **1 个**变体。
   - 抽卡模式：**逻辑不变**，仍用 `count` 与 `sampleAssessmentStylesByPolicy` 得到 `sampledStyles`，再循环生成。

4. **导出与类型**
   - 若 `lib/prompts.ts` 中 `StyleLabel` 或 `ASSESSMENT_STYLES` 未在前端使用，需通过共享类型或常量保证前后端 label 一致；或前端写死 A～E 与名称映射。

### 验收

- 仅传 `count`、不传 `selectedVariantLabel` 时，行为与现有一致（抽卡，滑动逻辑不变）。
- 传 `selectedVariantLabel: "A"` 且 `enableImageVariants: true` 时，生成 1 个 A 型变体。
- 传 `selectedVariantLabel: "A"` 且 `enableImageVariants: false` 时，返回 400 或明确错误提示。

---

## 需求四：前端首页布局与交互汇总

### 目标

- 首页表单结构清晰：模式切换 → 生成数量（抽卡）或变体类型单选（选择）→ 其余控件（主题、provider、图像变体等）→ 提交按钮。
- 默认进入为**选择模式**，用户可切换到抽卡模式；**抽卡模式下滑动条与原逻辑完全保持不变**。

### 迭代内容

1. **布局顺序建议**
   - 测试主题输入（保持不变）。
   - **模式切换**：如「抽卡随机 / 自主选择」，默认「自主选择」。
   - **生成数量**（含滑动条 + 数字按钮）：仅在**抽卡模式**下展示并生效，**与 V6 一致，不做改动**。
   - **变体类型单选**：仅在**选择模式**下展示；展示 A～E 及其中文名，**单选**必选 1 个；与图像变体开关联动（A 的可用性）。
   - 文本模型提供方、图像变体、质量门控等（保持原位置）。
   - 提交按钮。

2. **选择模式下数量展示**
   - 固定为「将生成 1 个变体」，无需滑动条。

3. **无障碍与提示**
   - 抽卡模式：可简短说明「系统将随机抽取 N 种测评风格」（与现有一致）。
   - 选择模式：可简短说明「选择一种要生成的测评风格」。

### 验收

- 默认进入首页为选择模式，可见变体类型**单选**；切换为抽卡模式后，可见生成数量滑动条（行为与 V6 一致），且不展示变体选择。
- 两种模式下提交均能正确触发对应后端逻辑；抽卡时按 count 随机生成，选择时固定生成 1 个指定类型变体。

---

## 实施顺序建议

| 顺序 | 需求 | 说明 |
|------|------|------|
| 1 | 需求一（模式变量） | 先定义 `variantInputMode` 与默认值，前端 state + 模式切换 UI，暂不接后端。 |
| 2 | 需求三（API 与后端） | 扩展 requestSchema、选择模式分支、按 `selectedVariantLabel` 生成 1 个变体的逻辑与校验。 |
| 3 | 需求二（变体类型单选） | 选择模式下的单选 UI、与图像变体联动、提交时传 `selectedVariantLabel`。 |
| 4 | 需求四（布局与交互） | 整合布局顺序、默认选择模式、提示文案与验收。 |

---

## 与现有能力的衔接

- **生成数量与滑动条**：抽卡模式下**完全保持 V6 行为**，不做任何改动；选择模式下不展示滑动条，固定生成 1 个变体。
- **图像变体开关**：与 A 型可用性、后端校验逻辑一致；不影响其他 provider、RunMode、ModelGate 等。
- **主题解构与质量门控**：仍基于 `topic` 与现有逻辑；选择模式下变体来源为「指定单个 label」，生成 1 个变体。
- **类型与常量**：`StyleLabel`、`ASSESSMENT_STYLES`、`STYLE_LABELS` 等保持在 `lib/prompts.ts`；前端如需展示名称，可复用或导出 `ASSESSMENT_STYLES` 的 name 映射。

---

## 名词与数据约定

| 名称 | 说明 |
|------|------|
| 抽卡模式 | 用户通过滑动条选择生成数量 N，后端从可用风格中**随机抽样** N 个变体类型并生成；**与 V6 一致，保持不变**。 |
| 选择模式 | 用户**单选**一种变体类型（A～E），后端按该 label 生成 **1 个**变体，无随机抽样。 |
| 变体类型 / label | A、B、C、D、E，对应 `ASSESSMENT_STYLES` 的五种测评风格（图像投射型、场景剧情型、依恋指数型、潜力预测型、心理自评型）。 |
| `variantInputMode` | 前端与请求体中的模式：`"draw"`（抽卡）或 `"select"`（选择），默认 `"select"`。 |
| `selectedVariantLabel` | 选择模式下，用户所选**单个**变体 label，如 `"A"`；仅生成 1 个变体。 |

---

文档已按上述确认定稿，可直接按实施顺序开发。
